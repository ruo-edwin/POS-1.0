<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Record Sales | SmartPOS</title>

  <link rel="stylesheet" href="https://rsms.me/inter/inter.css">

  <style>
    :root {
      --bg-body: #eef2f7;
      --bg-card: #ffffff;
      --border-soft: rgba(0,0,0,0.08);
      --accent: #4f46e5;
      --accent-strong: #6366f1;
      --text-main: #1f2937;
      --shadow-soft: 0 12px 30px rgba(0,0,0,0.08);
      --radius: 14px;
    }

    * { box-sizing: border-box; }

    body {
      font-family: "Inter", system-ui, sans-serif;
      background: linear-gradient(135deg, #f7f9fc, #e3e7f0);
      margin: 0;
      padding: 24px;
      display: flex;
      justify-content: center;
      color: var(--text-main);
    }

    .container { max-width: 1100px; width: 100%; }

    h1 {
      text-align: center;
      margin-bottom: 25px;
      font-size: 2rem;
      background: linear-gradient(120deg, #1f2937, #6366f1);
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
    }

    .order-info {
      background: var(--bg-card);
      padding: 18px;
      border-radius: var(--radius);
      margin-bottom: 25px;
      box-shadow: var(--shadow-soft);
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .order-info input {
      flex: 1;
      padding: 12px;
      min-width: 230px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
    }

    .table-wrapper {
      background: var(--bg-card);
      border-radius: var(--radius);
      padding: 10px;
      box-shadow: var(--shadow-soft);
      overflow-x: auto;
    }

    table { width: 100%; min-width: 900px; border-collapse: collapse; }

    th {
      background: #f3f4f6;
      padding: 14px;
      font-size: 0.75rem;
    }

    td {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid #e5e7eb;
    }

    td input {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      text-align: center;
    }

    td input[readonly] { background: #f3f4f6; }

    .btn-row { text-align: center; margin-top: 22px; }

    button {
      padding: 12px 24px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: white;
    }

    .total {
      text-align: center;
      font-size: 1.5rem;
      margin-top: 20px;
      font-weight: 600;
    }

    #message { text-align: center; margin-top: 15px; font-weight: 600; }

    a {
      display: block;
      text-align: center;
      margin-top: 25px;
      color: var(--accent);
      text-decoration: none;
    }

    .popup-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .popup-box {
      background: white;
      padding: 25px;
      border-radius: 14px;
      width: 90%;
      max-width: 360px;
      text-align: center;
    }

    .popup-buttons button { margin: 10px; }
  </style>
</head>

<body>
<div class="container">

<h1>Record Sales</h1>

<div class="order-info">
  <input id="clientName" placeholder="Customer Name (optional)">
  <input id="salesPerson" placeholder="Sold By (optional)">
</div>

<div class="table-wrapper">
<table>
<thead>
<tr>
<th>Product</th><th>Price</th><th>Stock</th><th>Qty</th><th>Total</th><th></th>
</tr>
</thead>
<tbody id="salesBody"></tbody>
</table>
</div>

<div class="btn-row">
<button onclick="addRow()">âž• Add Item</button>
</div>

<p class="total">Total Sale: Ksh <span id="grandTotal">0.00</span></p>

<div class="btn-row">
<button onclick="submitSale()">âœ… Record Sale</button>
</div>

<p id="message"></p>
<a href="/auth/dashboard">â¬… Back</a>

</div>

<!-- Payment popup -->
<div id="confirmPopup" class="popup-overlay">
  <div class="popup-box">
    <p id="popupText"></p>
    <hr>
    <h4>Mode of Payment</h4>
    <input id="mpesaAmount" type="number" placeholder="MPESA Amount" oninput="recalculatePayment()">
    <input id="cashAmount" type="number" placeholder="Cash Amount" oninput="recalculatePayment()">
    <p>Change: Ksh <span id="changeAmount">0.00</span></p>
    <div class="popup-buttons">
      <button onclick="approveSale()">Approve</button>
      <button onclick="closePopup()">Decline</button>
    </div>
  </div>
</div>

<!-- Shared searchable product list -->
<datalist id="productList"></datalist>

<script>
const baseURL = "https://pos-10-production.up.railway.app";
let allProducts = [];
let mpesa = 0, cash = 0;

async function loadProducts() {
  const res = await fetch(`${baseURL}/products/`, { credentials: "include" });
  allProducts = await res.json();

  productList.innerHTML = allProducts
    .map(p => `<option value="${p.name}"></option>`)
    .join("");

  addRow();
}

function addRow() {
  const row = document.createElement("tr");
  row.innerHTML = `
    <td>
      <input list="productList" placeholder="Search productâ€¦" oninput="updateProduct(this)">
    </td>
    <td><input class="price" readonly></td>
    <td><input class="stock" readonly></td>
    <td><input class="qty" type="number" min="1" oninput="updateTotal(this)"></td>
    <td><input class="lineTotal" readonly></td>
    <td><button onclick="this.closest('tr').remove();updateGrandTotal()">ðŸ—‘</button></td>
  `;
  salesBody.appendChild(row);
}

function updateProduct(input) {
  const p = allProducts.find(
    x => x.name.toLowerCase() === input.value.toLowerCase()
  );
  if (!p) return;

  const r = input.closest("tr");
  r.querySelector(".price").value = p.price;
  r.querySelector(".stock").value = p.quantity;
}

function updateTotal(q) {
  const r = q.closest("tr");
  const price = +r.querySelector(".price").value || 0;
  const stock = +r.querySelector(".stock").value || 0;
  if (q.value > stock) q.value = stock;
  r.querySelector(".lineTotal").value = (price * q.value).toFixed(2);
  updateGrandTotal();
}

function updateGrandTotal() {
  let t = 0;
  document.querySelectorAll(".lineTotal").forEach(i => t += +i.value || 0);
  grandTotal.textContent = t.toFixed(2);
}

function submitSale() {
  const items = [];
  document.querySelectorAll("#salesBody tr").forEach(r => {
    const name = r.querySelector("input[list]").value;
    const q = +r.querySelector(".qty").value;
    const p = allProducts.find(x => x.name === name);
    if (p && q > 0) items.push({ product_name: p.name, quantity: q });
  });

  if (!items.length) return alert("Add at least one product");

  popupText.innerHTML =
    `<strong style="font-size:1.3rem">Confirm order of Ksh ${Number(grandTotal.textContent).toLocaleString()}</strong>`;

  mpesaAmount.value = "";
  cashAmount.value = "";
  changeAmount.textContent = "0.00";
  confirmPopup.style.display = "flex";

  window.pendingSale = {
    client_name: clientName.value || null,
    sales_person: salesPerson.value || null,
    items
  };
}

function closePopup() {
  confirmPopup.style.display = "none";
}

function recalculatePayment() {
  mpesa = +mpesaAmount.value || 0;
  cash = +cashAmount.value || 0;
  const change = (mpesa + cash) - (+grandTotal.textContent);
  changeAmount.textContent = change > 0 ? change.toFixed(2) : "0.00";
}

async function approveSale() {
  if (mpesa + cash < +grandTotal.textContent)
    return alert("Total paid is less than sale amount");

  closePopup();

  const res = await fetch(`${baseURL}/sales/record_sale/`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "include",
    body: JSON.stringify(window.pendingSale)
  });

  if (res.ok) {
    message.style.color = "green";
    message.textContent = "Sale recorded successfully!";
    salesBody.innerHTML = "";
    addRow();
    updateGrandTotal();
  } else {
    message.style.color = "red";
    message.textContent = "Error recording sale";
  }
}

loadProducts();
</script>

</body>
</html>
