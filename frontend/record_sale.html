<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- PWA -->
<link rel="manifest" href="/static/manifest.json">
<meta name="theme-color" content="#635bff">

<!-- iOS support -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SmartPOS">
<link rel="apple-touch-icon" href="/static/icons/icon-192.png">

  <title>Record Sales | SmartPOS</title>

  <link rel="stylesheet" href="https://rsms.me/inter/inter.css">

  <style>
    :root {
      --bg-body: #eef2f7;
      --bg-card: #ffffff;
      --border-soft: rgba(0,0,0,0.08);
      --accent: #4f46e5;
      --accent-strong: #6366f1;
      --text-main: #1f2937;
      --shadow-soft: 0 12px 30px rgba(0,0,0,0.08);
      --radius: 14px;
    }

    * { box-sizing: border-box; }

    body {
      font-family: "Inter", system-ui, sans-serif;
      background: linear-gradient(135deg, #f7f9fc, #e3e7f0);
      margin: 0;
      padding: 24px;
      display: flex;
      justify-content: center;
      color: var(--text-main);
    }

    .container { max-width: 1100px; width: 100%; }

    h1 {
      text-align: center;
      margin-bottom: 25px;
      font-size: 2rem;
      background: linear-gradient(120deg, #1f2937, #6366f1);
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
    }

    /* âœ… Onboarding banner (only shows in onboarding mode) */
    .onboarding-banner {
      display: none;
      background: rgba(79, 70, 229, 0.08);
      border: 1px solid rgba(79, 70, 229, 0.18);
      padding: 14px 16px;
      border-radius: 14px;
      box-shadow: 0 10px 22px rgba(0,0,0,0.06);
      margin: 0 auto 18px;
      max-width: 980px;
    }
    .onboarding-banner strong { color: var(--accent); }

    /* âœ… Post-sale CTA (only onboarding mode, after success) */
    .cta-row {
      display: none;
      text-align: center;
      margin-top: 14px;
    }
    .cta-row a {
      display: inline-block;
      text-align: center;
      margin: 0;
      color: white;
      text-decoration: none;
      padding: 12px 20px;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
    }

    .order-info {
      background: var(--bg-card);
      padding: 18px;
      border-radius: var(--radius);
      margin-bottom: 25px;
      box-shadow: var(--shadow-soft);
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .order-info input {
      flex: 1;
      padding: 12px;
      min-width: 230px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
    }

    .table-wrapper {
      background: var(--bg-card);
      border-radius: var(--radius);
      padding: 10px;
      box-shadow: var(--shadow-soft);
      overflow-x: auto;
    }

    table { width: 100%; min-width: 900px; border-collapse: collapse; }

    th {
      background: #f3f4f6;
      padding: 14px;
      font-size: 0.75rem;
    }

    td {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid #e5e7eb;
    }

    td input {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      text-align: center;
    }

    td input[readonly] { background: #f3f4f6; }

    .btn-row { text-align: center; margin-top: 22px; }

    button {
      padding: 12px 24px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: white;
    }

    .total {
      text-align: center;
      font-size: 1.5rem;
      margin-top: 20px;
      font-weight: 600;
    }

    #message { text-align: center; margin-top: 15px; font-weight: 600; }

    a {
      display: block;
      text-align: center;
      margin-top: 25px;
      color: var(--accent);
      text-decoration: none;
    }

    .popup-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .popup-box {
      background: white;
      padding: 25px;
      border-radius: 14px;
      width: 90%;
      max-width: 360px;
      text-align: center;
    }

    .popup-buttons button { margin: 10px; }
  </style>
</head>

<body>
<div class="container">

<h1>Record Sales</h1>

<!-- âœ… Onboarding banner -->
<div class="onboarding-banner" id="onboardingBanner">
  <div><strong>Step 2 of 3:</strong> Record your first sale to see profit instantly.</div>
  <div style="margin-top:6px; color:#6b7280; font-size:0.95rem;">
    Add 1 product, enter quantity, then tap <strong>Record Sale</strong>.
  </div>
</div>

<div class="order-info">
  <input id="clientName" placeholder="Customer Name (optional)">
  <input id="salesPerson" placeholder="Sold By (optional)">
</div>

<div class="table-wrapper">
<table>
<thead>
<tr>
<th>Product</th><th>Price</th><th>Stock</th><th>Qty</th><th>Total</th><th></th>
</tr>
</thead>
<tbody id="salesBody"></tbody>
</table>
</div>

<div class="btn-row">
<button onclick="addRow()">âž• Add Item</button>
</div>

<p class="total">Total Sale: Ksh <span id="grandTotal">0.00</span></p>

<div class="btn-row">
<button onclick="submitSale()">âœ… Record Sale</button>
</div>

<p id="message"></p>

<!-- âœ… Onboarding CTA -->
<div class="cta-row" id="profitCta">
  <a href="/sales/salesreport?source=onboarding">ðŸ“Š View Profit Report</a>
</div>

<a href="/auth/dashboard">â¬… Back</a>

</div>

<div id="confirmPopup" class="popup-overlay">
  <div class="popup-box">
    <p id="popupText"></p>
    <hr>
    <h4>Mode of Payment</h4>
    <input id="mpesaAmount" type="number" placeholder="MPESA Amount" oninput="recalculatePayment()">
    <input id="cashAmount" type="number" placeholder="Cash Amount" oninput="recalculatePayment()">
    <p>Change: Ksh <span id="changeAmount">0.00</span></p>
    <div class="popup-buttons">
      <button onclick="approveSale()">Approve</button>
      <button onclick="closePopup()">Decline</button>
    </div>
  </div>
</div>

<datalist id="productList"></datalist>

<script>
const baseURL = "https://pos-10-production.up.railway.app";
let allProducts = [];
let mpesa = 0, cash = 0;

// âœ… Detect onboarding mode
const params = new URLSearchParams(window.location.search);
const isOnboarding = params.get("source") === "onboarding";

// âœ… Show onboarding banner if needed
const onboardingBanner = document.getElementById("onboardingBanner");
if (isOnboarding && onboardingBanner) onboardingBanner.style.display = "block";

async function loadProducts() {
  const res = await fetch(`${baseURL}/products/`, { credentials: "include" });
  allProducts = await res.json();

  productList.innerHTML = allProducts
    .map(p => `<option value="${p.name}"></option>`)
    .join("");

  addRow();
}

function addRow() {
  const row = document.createElement("tr");
  row.innerHTML = `
    <td>
      <input list="productList" placeholder="Search productâ€¦" oninput="updateProduct(this)">
    </td>
    <td>
      <input class="price" type="number" min="0" oninput="validatePrice(this)">
    </td>
    <td><input class="stock" readonly></td>
    <td><input class="qty" type="number" min="1" oninput="updateTotal(this)"></td>
    <td><input class="lineTotal" readonly></td>
    <td><button onclick="this.closest('tr').remove();updateGrandTotal()">ðŸ—‘</button></td>
  `;
  salesBody.appendChild(row);
}

function updateProduct(input) {
  const p = allProducts.find(
    x => x.name.toLowerCase() === input.value.toLowerCase()
  );
  if (!p) return;

  const r = input.closest("tr");
  r.querySelector(".price").value = p.price;
  r.querySelector(".price").dataset.minPrice = p.buying_price;
  r.querySelector(".stock").value = p.quantity;
}

function validatePrice(input) {
  const min = +input.dataset.minPrice || 0;
  if (+input.value < min) input.value = min;
  updateTotal(input.closest("tr").querySelector(".qty"));
}

function updateTotal(q) {
  const r = q.closest("tr");
  const price = +r.querySelector(".price").value || 0;
  const stock = +r.querySelector(".stock").value || 0;
  if (q.value > stock) q.value = stock;
  r.querySelector(".lineTotal").value = (price * q.value).toFixed(2);
  updateGrandTotal();
}

function updateGrandTotal() {
  let t = 0;
  document.querySelectorAll(".lineTotal").forEach(i => t += +i.value || 0);
  grandTotal.textContent = t.toFixed(2);
}

function submitSale() {
  const items = [];
  document.querySelectorAll("#salesBody tr").forEach(r => {
    const name = r.querySelector("input[list]").value;
    const q = +r.querySelector(".qty").value;
    const price = +r.querySelector(".price").value;
    if (name && q > 0) items.push({ product_name: name, quantity: q, selling_price: price });
  });

  if (!items.length) return alert("Add at least one product");

  popupText.innerHTML =
    `<strong style="font-size:1.3rem">Confirm order of Ksh ${Number(grandTotal.textContent).toLocaleString()}</strong>`;

  confirmPopup.style.display = "flex";

  window.pendingSale = {
    client_name: clientName.value || null,
    sales_person: salesPerson.value || null,
    items
  };
}

function closePopup() {
  confirmPopup.style.display = "none";
}

function recalculatePayment() {
  mpesa = +mpesaAmount.value || 0;
  cash = +cashAmount.value || 0;
  const change = (mpesa + cash) - (+grandTotal.textContent);
  changeAmount.textContent = change > 0 ? change.toFixed(2) : "0.00";
}

async function approveSale() {
  if (mpesa + cash < +grandTotal.textContent)
    return alert("Total paid is less than sale amount");

  closePopup();

  // âœ… NEW: pass onboarding source to backend only when onboarding
  const postUrl = `${baseURL}/sales/record_sale/${isOnboarding ? "?source=onboarding" : ""}`;

  const res = await fetch(postUrl, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "include",
    body: JSON.stringify(window.pendingSale)
  });

  const out = await res.json().catch(() => ({}));

  if (res.ok) {
    const total = Number(out.total_amount || grandTotal.textContent || 0);

    message.style.color = "green";

    if (isOnboarding) {
      const demoLine = out.is_demo
        ? `<div style="margin-top:8px; color:#6b7280; font-weight:600;">
             ðŸ§ª This was a <strong>demo sale</strong>. Your stock was <strong>NOT</strong> reduced.
             When you record your next sale, this demo will disappear automatically.
           </div>`
        : ``;

      message.innerHTML = `
        âœ… First sale recorded!<br>
        <span style="color:#6b7280; font-weight:600;">
          Order: <strong>${out.order_code || "-"}</strong> â€¢ Total: <strong>Ksh ${total.toLocaleString()}</strong><br>
          Now tap <strong>View Profit Report</strong> below ðŸ‘‡
        </span>
        ${demoLine}
      `;

      const cta = document.getElementById("profitCta");
      if (cta) cta.style.display = "block";
    } else {
      message.textContent = "Sale recorded successfully!";
    }

    salesBody.innerHTML = "";
    addRow();
    updateGrandTotal();
  } else {
    message.style.color = "red";
    message.textContent = out.detail || "Error recording sale";
  }
}

loadProducts();

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/static/service-worker.js")
    .then(() => console.log("Service Worker registered"))
    .catch(err => console.error("SW registration failed:", err));
}
</script>

</body>
</html>
