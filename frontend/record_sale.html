<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Record Sales</title>
  <style>
    body {
      font-family: "Poppins", Arial, sans-serif;
      background-color: #f7f7f7;
      text-align: center;
      padding: 20px;
      margin: 0;
    }

    h1 {
      color: #333;
      font-size: 1.8rem;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      max-width: 1000px;
      margin: 0 auto 20px auto;
      border-collapse: collapse;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      font-size: 0.95rem;
    }

    th, td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      text-align: center;
      vertical-align: middle;
    }

    th {
      background-color: #4CAF50;
      color: white;
      font-weight: 600;
    }

    input, select {
      padding: 8px;
      width: 100%;
      border-radius: 6px;
      border: 1px solid #ccc;
      text-align: center;
      font-size: 0.95rem;
    }

    input[readonly] {
      background-color: #f0f0f0;
    }

    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #45a049;
    }

    .total {
      font-weight: bold;
      font-size: 1.2rem;
      margin-top: 15px;
      color: #333;
    }

    a {
      display: inline-block;
      margin-top: 20px;
      color: #4CAF50;
      text-decoration: none;
      font-weight: 500;
    }

    #message {
      margin-top: 15px;
      font-weight: 500;
    }

    /* ‚úÖ Responsive Styles */
    @media (max-width: 992px) {
      body {
        padding: 15px;
      }

      table {
        font-size: 0.9rem;
      }

      th, td {
        padding: 8px;
      }

      h1 {
        font-size: 1.6rem;
      }

      button {
        font-size: 0.95rem;
        padding: 9px 16px;
      }
    }

    @media (max-width: 768px) {
      table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }

      h1 {
        font-size: 1.5rem;
      }

      .total {
        font-size: 1.1rem;
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.3rem;
      }

      button {
        width: 100%;
        margin-top: 10px;
      }

      a {
        font-size: 0.95rem;
      }

      .total {
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>
  <h1>Record Sales</h1>

  <table id="salesTable">
    <thead>
      <tr>
        <th>Product</th>
        <th>Price (Ksh)</th>
        <th>Current Stock</th>
        <th>Quantity Sold</th>
        <th>Total (Ksh)</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="salesBody"></tbody>
  </table>

  <button onclick="addRow()">‚ûï Add Item</button>
  <p class="total">Total Sale: Ksh <span id="grandTotal">0.00</span></p>
  <button onclick="submitSale()">‚úÖ Record Sale</button>

  <p id="message"></p>

  <a href="https://pos-10-production.up.railway.app/auth/dashboard">‚¨Ö Back to Home</a>

  <script>
    const baseURL = "https://pos-10-production.up.railway.app";
    let allProducts = [];

    async function loadProducts() {
      try {
        const res = await fetch(`${baseURL}/products/`, { credentials: 'include' });
        if (!res.ok) throw new Error("Failed to fetch products");
        allProducts = await res.json();
        addRow();
      } catch (error) {
        console.error("‚ùå Error loading products:", error);
        document.getElementById("message").textContent = "‚ùå Could not load products.";
      }
    }

    function addRow() {
      const tbody = document.getElementById("salesBody");
      const row = document.createElement("tr");

      const productOptions = allProducts.map(
        p => `<option value="${p.id}">${p.name}</option>`
      ).join("");

      row.innerHTML = `
        <td>
          <select onchange="updateProductDetails(this)">
            <option value="">-- Select Product --</option>
            ${productOptions}
          </select>
        </td>
        <td><input type="number" id="price" readonly></td>
        <td><input type="number" id="stock" readonly></td>
        <td><input type="number" id="quantity" min="1" oninput="updateRowTotal(this)"></td>
        <td><input type="number" id="total" readonly></td>
        <td><button onclick="removeRow(this)">üóëÔ∏è</button></td>
      `;

      tbody.appendChild(row);
    }

    function removeRow(btn) {
      btn.closest("tr").remove();
      updateGrandTotal();
    }

    function updateProductDetails(selectEl) {
      const row = selectEl.closest("tr");
      const selected = allProducts.find(p => p.id == selectEl.value);
      if (!selected) return;

      row.querySelector("#price").value = selected.price;
      row.querySelector("#stock").value = selected.quantity;
      row.querySelector("#quantity").value = "";
      row.querySelector("#total").value = "";
      updateGrandTotal();
    }

    function updateRowTotal(qtyInput) {
      const row = qtyInput.closest("tr");
      const price = parseFloat(row.querySelector("#price").value) || 0;
      const stock = parseInt(row.querySelector("#stock").value) || 0;
      const qty = parseInt(qtyInput.value) || 0;
      const msg = document.getElementById("message");

      if (qty > stock) {
        msg.style.color = "red";
        msg.textContent = "‚ùå Quantity exceeds stock!";
        qtyInput.value = stock;
      } else {
        msg.textContent = "";
      }

      const total = price * qty;
      row.querySelector("#total").value = total.toFixed(2);
      updateGrandTotal();
    }

    function updateGrandTotal() {
      let total = 0;
      document.querySelectorAll("#total").forEach(input => {
        total += parseFloat(input.value) || 0;
      });
      document.getElementById("grandTotal").textContent = total.toFixed(2);
    }

    async function submitSale() {
      const rows = document.querySelectorAll("#salesBody tr");
      const items = [];

      rows.forEach(row => {
        const select = row.querySelector("select");
        const productId = select.value;
        const product = allProducts.find(p => p.id == productId);
        const qty = parseInt(row.querySelector("#quantity").value);

        if (productId && qty > 0) {
          items.push({
            product_name: product.name,
            quantity: qty
          });
        }
      });

      if (items.length === 0) {
        alert("Please add at least one product!");
        return;
      }

      try {
        const response = await fetch(`${baseURL}/sales/record_sale/`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ items }),
          credentials: "include"
        });

        const result = await response.json();
        const msg = document.getElementById("message");

        if (response.ok) {
          msg.style.color = "green";
          msg.textContent = result.message || "‚úÖ Sale recorded successfully!";
          document.getElementById("salesBody").innerHTML = "";
          addRow();
          updateGrandTotal();
        } else {
          msg.style.color = "red";
          msg.textContent = result.detail || "‚ùå Failed to record sale.";
        }
      } catch (error) {
        console.error("‚ùå Sale submission error:", error);
        document.getElementById("message").textContent = "‚ùå Error submitting sale.";
      }
    }

    loadProducts();
  </script>
</body>
</html>
